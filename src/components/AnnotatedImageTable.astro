---
import { getThumbnail } from "./SharedJSFunctions.js";

interface Props {
  study: any;
  sourceImages: any[];
  annotatedImagesMap: Map<string, any[]>;
  sourceDataset: any[];
  imagePageRoot?: string;
  sectionId?: string;
}

const {
  study,
  sourceImages,
  annotatedImagesMap,
  sourceDataset,
  imagePageRoot = "/bioimage-archive/image/",
  sectionId = "viewable_images"
} = Astro.props;
---

<section class="vf-content | embl-grid embl-grid--has-centered-content">
  <div>
    <h2 class="vf-section-header__heading" id={sectionId}>Viewable Annotated Images</h2>
  </div>
  <div class="vf-grid__col--span-2">
    <table id="viewable_images_table" class="display vf-table">
      <thead class="vf-table__header">
        <tr>
          <th class="vf-table__heading" scope="col">Image Preview</th>
          <th class="vf-table__heading" scope="col">Annotation Preview</th>
          <th class="vf-table__heading" scope="col">Image UUID</th>
          <th class="vf-table__heading" scope="col">Image Dataset</th>
          <th class="vf-table__heading" scope="col">Annotation UUID</th>
          <th class="vf-table__heading" scope="col">Annotation Dataset</th>
          <th class="vf-table__heading" scope="col">Actions</th>
        </tr>
      </thead>
      <tbody class="vf_table__body">
      {sourceImages.filter(img => annotatedImagesMap.has(img.uuid)).map((sourceImage, rowIndex) => {
        const annotatedImgs = annotatedImagesMap.get(sourceImage.uuid) || [];
        return (
          <tr>
            <td>
              <a href={`${imagePageRoot}${sourceImage?.uuid}` || "#"}>
              <img src={getThumbnail(sourceImage)} alt="Preview" width="80" /></td>
              </a>
            <td>
              <div class="slideshow-container" data-row={rowIndex}>
              {annotatedImgs.length > 1 ? annotatedImgs.map((annImg, i) => (
                <div class="slides fade" style={`display: ${i === 0 ? "block" : "none"}`}>
                <a href={`${imagePageRoot}${annImg.uuid}`}><img src={getThumbnail(annImg)} alt="Annotation Preview" width="80"/></a>
                </div>
              )) : annotatedImgs.map((annImg) => (<a href={`${imagePageRoot}${annImg.uuid}`}><img src={getThumbnail(annImg)} alt="Annotation Preview" width="80"/></a>))
              }
              </div>
            </td>
            <td>{sourceImage.uuid}</td>
            <td>{sourceDataset.find(dataset => dataset.image.some(image => image.uuid === sourceImage.uuid))?.title || ""}</td>
            <td>
              <div class="uuid-container">
                {annotatedImgs.map((annImg, i) => (
                  <span class="uuid" style={`display: ${i === 0 ? "inline" : "none"}`}>{annImg.uuid}</span>
                ))}
              </div>
            </td>
            <td>
              <div class="dataset-title-container">
                {annotatedImgs.map((annImg, i) => {
                  const dataset = study.dataset.find(ds =>
                    ds.image?.some(image => image.uuid === annImg.uuid)
                  );
                  return (
                    <span class="dataset-title" style={`display: ${i === 0 ? "inline" : "none"}`}>
                      {dataset?.title || ""}
                    </span>
                  );
                })}
              </div>
            </td>
            <td>
              <a href={`${imagePageRoot}${sourceImage.uuid}`}>View</a>
            </td>
          </tr>
        );
      })}
    </tbody>
    </table>
  </div>
</section>
<script type="module">
document.addEventListener("DOMContentLoaded", function () {
  $("#viewable_images_table").DataTable({
    scrollX: true,
    columnDefs: [{ type: "natural", targets: 0 }],
  });
  document.querySelectorAll("tr").forEach((row) => {
    const slides = row.querySelectorAll(".slides");
    const uuids = row.querySelectorAll(".uuid");
    const titles = row.querySelectorAll(".dataset-title");

    if (slides.length <= 1 || uuids.length <= 1) return;

    let index = 0;

    setInterval(() => {
      slides.forEach((s) => (s.style.display = "none"));
      uuids.forEach((u) => (u.style.display = "none"));
      titles.forEach((t) => (t.style.display = "none"));
      slides[index].style.display = "block";
      uuids[index].style.display = "inline";
      titles[index].style.display = "inline";
      index = (index + 1) % slides.length;
    }, 3500);
  });
});
</script>
