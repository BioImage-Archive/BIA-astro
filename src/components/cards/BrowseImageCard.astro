---
import { formatListItem, getThumbnail, getSimpleAttributeValue, formatPhysicalDimensions, formatPixelDimensions, applyHighlight, highlightLinks } from "../SharedJSFunctions.js";
import "../../styles/dataset_card.css"
import  HighlightedText  from "../HighlightedText.astro";
import { highlightImagingMethod } from "./BrowseStudyCard.astro"
import imageFallback from "../../assets/bioimage-archive/image_fallback.png"

const { image, imagePageRoot, taglist, annotationType, highlight, cardImageOverride, query} = Astro.props;

export function highlightOrganism(text, highlight, query){
    const highlightOrganism = highlight?.['creation_process.subject.sample_of.organism_classification.common_name']?.[0] || highlight?.['creation_process.subject.sample_of.organism_classification.scientific_name']?.[0];
    return query && text? applyHighlight(text, highlightOrganism, query): text;

}

export function highlightImageFormat(text, highlight, query){

}

const vizarrRepUuid = getSimpleAttributeValue(image, "recommended_vizarr_representation");
const interactiveImageRepresentation = (image.representation.find(
    (rep) => rep.uuid == vizarrRepUuid
) ?? image.representation.find( (rep) => rep.image_format === ".ome.zarr") )

type Taxon = {
  scientific_name?: string;
  common_name?: string;
};
const taxons: Taxon[] = [
  ...new Map(
    (image?.creation_process?.subject?.sample_of ?? [])
      .flatMap(s => s?.organism_classification ?? [])
      .filter(Boolean)
      .map((t: Taxon) => [
        t.scientific_name || t.common_name,
        { scientific_name: t.scientific_name, common_name: t.common_name }
      ])
  ).values()
];
const taxonNames = taxons.map(t =>
  t?.common_name ? `${t?.scientific_name} (${t?.common_name})` : t?.scientific_name
);

const imagingMethod = [
  ...new Set(
    (image?.creation_process?.acquisition_process ?? [])
      .flatMap(ap => ap?.imaging_method_name ?? [])
      .filter(Boolean).sort()
  )
];

const imageFormat = [
  ...new Set(
    (image?.representation ?? [])
      .flatMap(rep => rep?.image_format.replace("\.", "") ?? [])
      .filter(Boolean).sort()
  )
];
const highLightedImageFormat = imageFormat.flatMap(imf=> query && imf? applyHighlight(imf, highlight?.["representation.image_format"]?.[0], query): imf)

const accessionId = image?.accession_id || "";

const isNonZeroNumber = (v) => {
  const n = Number(v);
  return Number.isFinite(n) && n !== 0;
};

const hasPhysical =
  isNonZeroNumber(image?.total_physical_size_x) ||
  isNonZeroNumber(image?.total_physical_size_y) ||
  isNonZeroNumber(image?.total_physical_size_z);

const hasPixel =
  isNonZeroNumber(interactiveImageRepresentation?.size_x) ||
  isNonZeroNumber(interactiveImageRepresentation?.size_y) ||
  isNonZeroNumber(interactiveImageRepresentation?.size_z);

const showSizeBar = hasPhysical || hasPixel;
const thumbnail_uri =  getThumbnail(image);
const isFallback = thumbnail_uri === imageFallback.src;
const fallbackMessage = isFallback ? "Preview not available yet." : "";
const base = `/bioimage-archive/${imagePageRoot}/${image.uuid}`;
const highlightedImageLink = highlightLinks(base, highlight, query);
---
<article class="vf-card vf-card--brand vf-card--bordered custom-card" style="max-width:400px" data-message={image.uuid}>
    
    <div class="image-container ">
        <img src={thumbnail_uri } alt={fallbackMessage} title={fallbackMessage} class="vf-card__image" loading="lazy" style="aspect-ratio: 1/1;">
        {isFallback && (
            <div class="image-overlay" role="note" aria-label={fallbackMessage}>
                <span>{fallbackMessage}</span>
            </div>
        )}
        {
            showSizeBar && (
            <div class="size-bar">
                {
                    hasPhysical && (
                        <span class="physical-size">
                            <code>{ formatPhysicalDimensions(image)}</code>
                        </span>
                    )
                }
                {
                    hasPixel && (
                        <span class="image-size">
                            <code>{ formatPixelDimensions(interactiveImageRepresentation)}</code>
                        </span>
                    )
                }
                </div>
            )
        }   
        <div class="study-link">
            { accessionId }
        </div>
    </div>
    <div class="vf-card__content">
        <p class="vf-card__text">
            <b>Imaging method: </b><HighlightedText text={imagingMethod.flatMap(im=> highlightImagingMethod(im, highlight?.["creation_process.acquisition_process.imaging_method_name"], query)).join(", ")} /><br>
            <b>Organism: </b><HighlightedText text={taxonNames.map(taxon => highlightOrganism(taxon, highlight, query)).join(", ")} /><br>
            <b>Image format: </b><HighlightedText text={highLightedImageFormat.join(", ")} /><br>
            {interactiveImageRepresentation?.size_c && (<><b>Number of channels:</b> {interactiveImageRepresentation?.size_c}<br /></>)}
            {interactiveImageRepresentation?.size_t && (<><b>Number of timesteps:</b> {interactiveImageRepresentation?.size_t}</>)}
        </p>

        {taglist && taglist.length > 0 && (
            <p class="vf-card__text">
                <b>Tags:</b> {taglist.reduce(formatListItem, "")}
            </p>
        )}

        {annotationType && annotationType.length > 0 && (
            <p class="vf-card__text">
                <b>Annotation Type:</b> {annotationType.join(", ") || "No information available"}
            </p>
        )}
        <h3 class="vf-card__heading"><a class="vf-card__link" href={highlight? highlightedImageLink : base} ></a></h3>
    </div>
</article>
<style>
    .row {
        margin-bottom: 5px;
    }
    .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        padding: 8px 12px 4px 12px;
        justify-content: center;
    }
    button {
        padding: 6px 12px;
        border: 1px solid #666;
        border-radius: 4px;
        background: #f5f5f5;
        transition: all 0.2s ease;
    }
    button:hover {
        background: #e0e0e0;
        transform: translateY(-1px);
    }
    button a {
        text-decoration: none;
        color: #333;
    }
    .title-container {
        height: 2em;  /* Two lines of text */
        margin: 0;
        overflow: hidden;
    }
    .title-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.8em;
        line-height: 1.2em;
    }
    .subtitle-text {
        font-size: 0.9em;
        color: #666;
        margin: 0;
        padding: 0;
    }
    .image-container {
        width: 100%;
        overflow: hidden;
        position: relative;
    }
    .size-bar {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(243, 243, 243, 0.9);
        padding: 8px 12px;
        font-size: 0.9em;
        display: flex;
        flex-direction: column;
        gap: 4px;
        border-radius: 4px;
        max-width: 80%;
    }
    .physical-size, .image-size, .voxel-size {
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .x-text {
        font-size: 0.8em;
        vertical-align: middle;
        color: #666;
    }
    .unit-text {
        font-size: 0.8em;
        color: #666;
    }

    .study-link {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(243, 243, 243, 0.9);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .study-link a {
        color: #333;
        text-decoration: none;
    }
    .study-link a:hover {
        text-decoration: underline;
    }
    .license-badge {
        position: absolute;
        top: 45px;
        right: 10px;
        background: rgba(243, 243, 243, 0.9);
        padding: 2px;
        border-radius: 4px;
    }
    .license-badge img {
        height: var(--license-badge-height, 20px);
        width: auto;
    }
    .image-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 12px;
        opacity: 1;
        pointer-events: none;
        z-index: 999;
    }
</style>
