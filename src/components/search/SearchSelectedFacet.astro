---
import { generateParamString, formatBytes } from "../SharedJSFunctions.js";
import {type SelectedFacets} from "./SearchInterface.astro";
import { capitalizeFirstLetter } from "./SearchFacet.astro"

const { selectedList, key, url, text, query, selectedFacets, kind, minVal, maxVal, pageSize = 12} = Astro.props;

const page = 1;

function removeFacetValue(
  facets: SelectedFacets,
  key: string,
  value: string
): SelectedFacets {
  return {
    ...facets,
    [key]: (facets[key] ?? []).filter((v) => v !== value),
  };
}

function removeQueryParam(url) {
  const next = new URL(url);
  next.searchParams.delete("query");
  return next.toString();
}

function removeRange(facets: SelectedFacets, gteKey: string, lteKey: string): SelectedFacets {
  const next = { ...facets };
  delete next[gteKey];
  delete next[lteKey];
  return next;
}
const gteKey = kind ==="range" || kind ==="slider"? `${key}.gte` : "";
const lteKey = kind ==="range" || kind ==="slider" ? `${key}.lte` : "";

const show = (minVal && minVal !== "") || (maxVal && maxVal !== "");
const label = `${minVal && minVal !== "" ? formatBytes(minVal, key) : "…" } – ${maxVal && maxVal !== "" ? formatBytes(maxVal, key) : "…"}`;
---
{selectedList && selectedList.length > 0  && (
    <>
    {text}: 
    {selectedList.map( selected => 
    <a href={generateParamString(url, query, page, removeFacetValue(selectedFacets, key, selected), pageSize)} 
        class="facet-remove-btn" aria-label={`Remove ${text}: ${selected}`}
      >
        <span class="facet-value">{capitalizeFirstLetter(selected.replaceAll("_", " "))}</span>
        <span class="facet-x" aria-hidden="true">×</span></a>
    )
    }
    </>
    )   
}
{show && (
  <>
    {text}:
    <a
      href={generateParamString(url, query, page, removeRange(selectedFacets, gteKey, lteKey), pageSize)}
      class="facet-remove-btn"
      aria-label={`Remove ${text}: ${label}`}
      >
        <span class="facet-value">{label}</span>
        <span class="facet-x" aria-hidden="true">×</span>
    </a>
  </>
)}
{
  kind === "query" && query!=="" && (
    <>
    {text}:
    <a
      href={generateParamString(removeQueryParam(Astro.url), "", page, [], pageSize)}
      class="facet-remove-btn"
      aria-label={`Remove ${text}: ${query}`}
    >
      <span class="facet-value">{query}</span>
      <span class="facet-x" aria-hidden="true">×</span>
    </a>
  </>
  )
}

<style>
  .facet-remove-btn {
  display: inline-block;
  background-color: #e1ecf4;
  color: #0366d6;
  border-radius: 2em;
  padding: 0.3em 0.8em;
  margin: 0 0.5em 0.5em 0;
  font-size: 0.85rem;
  text-decoration: none;
  transition: background-color 0.2s;
}

.facet-remove-btn:hover {
  background-color: #d1e3f3;
}
.facet-x {
    font-weight: 700;
    line-height: 1;
    opacity: 0.8;
    margin-left: 0.5em;
  }

  .facet-remove-btn:hover .facet-x {
    opacity: 1;
  }
</style>