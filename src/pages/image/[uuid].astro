---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SourceImage from "../../components/SourceImage.astro"
import DatasetDetail from '../../components/DatasetDetail.astro';

import field_map from "../../data/metadata-field-name-mapping.json";
import dataset_metdata from "../../data/bia-dataset-metadata-for-images.json";
import image_data from "../../data/bia-image-metadata.json";
import image_fallback from "../../assets/bioimage-archive/image_fallback.png"

const biosample_map = field_map["biosample"];
const sipp_map = field_map["specimen_imaging_preparation_protocol"];
const image_acquisition_map = field_map["image_acquisition"];
const annotation_method_map = field_map["annotation_method"];
const protocol_map = field_map["protocol"];

export function getStaticPaths() {
  return Object.keys(image_data).map((uuid) => {
    return {
      params:  { uuid: uuid }
    };
  });
}

function getSimpleAttributeValue(obj, attrName) {
  return obj?.attribute
    ?.find(attr => attr.name === attrName)
    ?.value[attrName] ?? null;
}

const { uuid } = Astro.params;

const image = image_data[uuid];

const image_dataset = dataset_metdata[image.submission_dataset_uuid]
const image_study = image_dataset.submitted_in_study
const interactive_image = image.representation.find((rep) => rep.use_type === "INTERACTIVE_DISPLAY")
const static_display = image.representation.find((rep) => rep.use_type === "STATIC_DISPLAY")
const thumbnail = image.representation.find((rep) => rep.use_type === "THUMBNAIL")
const user_submitted = image.representation.find((rep) => rep.use_type === "UPLOADED_BY_SUBMITTER")

var primary_image_rep
if (interactive_image != null) {
    primary_image_rep = interactive_image
} else if (static_display != null) {
    primary_image_rep = static_display
} else if (thumbnail != null) {
    primary_image_rep = thumbnail
} else if (user_submitted != null) {
    primary_image_rep = user_submitted
} else {
    primary_image_rep = null
}

var vizarr_iframe_source
var itk_link
if (interactive_image != null) {
    vizarr_iframe_source = "https://uk1s3.embassy.ebi.ac.uk/bia-zarr-test/vizarr/index.html?source=" + interactive_image.file_uri[0]
    itk_link = "https://kitware.github.io/itk-vtk-viewer/app/?fileToLoad=" + interactive_image.file_uri[0]
} else {
    vizarr_iframe_source = null
    itk_link = null
}

const pref_ng_image_rep_uuid = getSimpleAttributeValue(image, "preferred_neuroglancer_image_representation_uuid")
const pref_ng_image_rep = image.representation.find((rep) => rep.uuid === pref_ng_image_rep_uuid)
const ng_link = pref_ng_image_rep ? getSimpleAttributeValue(pref_ng_image_rep, "neuroglancer_view_link") : null

const creation_process = image.creation_process

let specimen
if ("subject" in creation_process && creation_process.subject != null) {
    specimen = creation_process.subject
}




function formatPhysicalDimension(value, text) {
    if (text === "") {
        if (value != null) {
            return value + "m"
        } else {
            return text
        }
    } else {
        if (value != null) {
            return text + " x " + value + "m"
        } else {
            return text
        }
    }
}

function formatPhysicalDimensions(img_rep) {
    const fields = [ "physical_size_x", "physical_size_y", "physical_size_z"]
    return fields.reduce((text, field) => formatPhysicalDimension(img_rep[field], text), "")
}



function formatPixelDimension(value, text) {
    if (text === "") {
        if (value != null) {
            return value
        } else {
            return text
        }
    } else {
        if (value != null) {
            return text + " x " + value
        } else {
            return text
        }
    }
}

function formatPixelDimensions(img_rep) {
    const fields = [ "size_x", "size_y", "size_z"]
    return fields.reduce((text, field) => formatPixelDimension(img_rep[field], text), "")
}


function getDisplayImage() {
    if (vizarr_iframe_source) {
        return ` <iframe style="width: 100%; height: 500px" name="vizarr" src="${vizarr_iframe_source}"></iframe>`
    }

    if (primary_image_rep && primary_image_rep.use_type !== "UPLOADED_BY_SUBMITTER" && primary_image_rep.file_uri?.[0]) {
        return ` <img style="width: 100%; height: 500px" src="${primary_image_rep.file_uri[0]}" />`;
    }

    return `<img style="height: 500px;" src="${image_fallback.src}" />`;
}


---

<BaseLayout pageTitle={image["accession_id"] + ":" + image["alias"]}>
  <body>
    <div class="vf-stack vf-stack--500">
        <section class="vf-content | embl-grid embl-grid--has-centered-content">
            <div></div>
            <div>
                <h1 class="vf-intro__heading vf-intro__heading--has-tag">{ image_study.accession_id }<a href="JavaScript:Void(0);" class="vf-badge vf-badge--primary vf-badge--phases">alpha</a></h1>
                <h2 class="vf-intro__subheading">{image_study.title}</h2>
                <p class="studytitle">{image_dataset.title_id}</p>
                <a href={ "/bioimage-archive/dataset/" + image_study.accession_id}>
                    <button class="vf-button vf-button--primary vf-button--sm">Study Page</button>
                </a> 
            </div>
        </section>
        <section class="vf-content | embl-grid embl-grid--has-centered-content">
            <div>
                <h3>Image metadata</h3>

                <b>Physical Image size: </b> {formatPhysicalDimensions(primary_image_rep)}<br>
                <b>Pixel Image size: </b> {formatPixelDimensions(primary_image_rep)}<br>
                {primary_image_rep.size_c != null && (<><b>Number of channels:</b> {primary_image_rep.size_c}<br/></>)}
                {primary_image_rep.size_t != null && (<><b>Number of timesteps:</b> {primary_image_rep.size_t}<br/></>)}
            </div>
            <div set:html={getDisplayImage()} style="display: flex; justify-content: center;"></div>

            <div>
                <h3>Access images</h3>
                License: {image_study.licence} <br/>
                <br/>
                <a href={"/bioimage-archive/help/downloading-data#aws_client_download"}>How to download this image</a><br/>
                <br/>
                {
                    primary_image_rep && (
                        <button class="vf-button vf-button--primary vf-button--sm" id="CopyURLButton" data-url={primary_image_rep.file_uri[0]}>Copy OME-Zarr URI</button>
                    )
                }
                {
                    ( vizarr_iframe_source || itk_link || ng_link ) && (
                        <h3>Visualise</h3>
                    )
                }
                {
                    vizarr_iframe_source && (
                        <a href={vizarr_iframe_source}>
                            <button class="vf-button vf-button--primary vf-button--sm">Open in Vizarr viewer</button>
                        </a>
                    )
                }
                {
                    itk_link && (
                        <a href={itk_link}>
                            <button class="vf-button vf-button--primary vf-button--sm">Open in ITK viewer</button>
                        </a>
                    )
                }
                {
                    ng_link && (
                        <a href={ng_link}>
                            <button class="vf-button vf-button--primary vf-button--sm">Open in neuroglancer</button>
                        </a>
                    )
                }
                <script>

                    let copyUrlButton = document.getElementById("CopyURLButton")
                    let originalText = copyUrlButton.innerText;
                    copyUrlButton.onclick=async() => {
                        await copyUrl(copyUrlButton.dataset.url, copyUrlButton, originalText);
                    };

                    async function copyUrl(url, button, originalText) {
                        await navigator.clipboard.writeText(url);
                        button.innerText = "URI Copied";
                        setTimeout(() => {
                            button.innerText = originalText;
                        }, 700);
                    }

                </script>
            </div>
        </section>

        <!-- TODO: Include links to source images using  <SourceImage image={ image}/> for derived images -->

        <hr/>

        <section class="vf-content | embl-grid embl-grid--has-centered-content">
            <div>
                <h3>Study</h3>
            </div>
            <div style="overflow-wrap: anywhere;">
                <b>Title</b>: {image_study.title}<br/>
                <b>Description:</b> {image_study.description} <br/>
                <b>Licence:</b> {image_study.licence} <br/>
            </div>
        </section>

        <hr/>

        <section class="vf-content | embl-grid embl-grid--has-centered-content">
            <div>
                <h3>Dataset</h3>
            </div>
            <div>
                <b>Title</b>: {image_dataset.title_id}<br/>
                <b>Description:</b> {image_dataset.description}<br/>
            </div> 
        </section>

        <hr/>
        
        <section class="vf-content | embl-grid embl-grid--has-centered-content">
            <div>
                <h3>Subject</h3>
            </div>
            <div>
            {
                specimen != null && "sample_of" in specimen &&
                    specimen.sample_of.length > 0 && (
                        <b>Biosamples:</b>
                        <ul>
                            {specimen.sample_of.map((biosample) => (
                                <DatasetDetail
                                    data={biosample}
                                    field_map={biosample_map}
                                />
                            ))}
                        </ul>
                    )
            }
            {
                specimen != null && "imaging_preparation_protocol" in specimen &&
                    specimen.imaging_preparation_protocol.length > 0 && (
                        <b>Specimen Preparation Protocols:</b>
                        <ul>
                            {specimen.imaging_preparation_protocol.map((sipp) => (
                                <DatasetDetail
                                    data={sipp}
                                    field_map={sipp_map}
                                />
                            ))}
                        </ul>
                    )
            }
            </div>
        </section>

        <hr/>

        <section class="vf-content | embl-grid embl-grid--has-centered-content">
            <div>
                <h3>Creation</h3>
            </div>
            <div>
                {
                    "acquisition_process" in creation_process &&
                        creation_process.acquisition_process.length > 0 && (
                            <b>Image Acquisition Protocols:</b>
                            <ul>
                                {creation_process.acquisition_process.map(
                                    (image_acquisition) => (
                                        <DatasetDetail
                                            data={image_acquisition}
                                            field_map={image_acquisition_map}
                                        />
                                    ),
                                )}
                            </ul>
                        )
                }
                {
                    "annotation_method" in creation_process &&
                        creation_process.annotation_method.length > 0 && (
                            <b>Image Acquisition Protocols:</b>
                            <ul>
                                {creation_process.annotation_method.map(
                                    (annotation_method) => (
                                        <DatasetDetail
                                            data={annotation_method}
                                            field_map={annotation_method_map}
                                        />
                                    ),
                                )}
                            </ul>
                        )
                }
                {
                    "protocol" in creation_process &&
                        creation_process.protocol.length > 0 && (
                            <b>Image Acquisition Protocols:</b>
                            <ul>
                                {creation_process.protocol.map(
                                    (protocol) => (
                                        <DatasetDetail
                                            data={protocol}
                                            field_map={protocol_map}
                                        />
                                    ),
                                )}
                            </ul>
                        )
                }
            </div>
        </section>
    </body>
</BaseLayout>
