---
import BaseLayoutWithBreadcrumbs from "../../layouts/BaseLayoutWithBreadcrumbs.astro";
import StudyTitleInfo from "../../components/study-page/StudyTitleInfo.astro";
import StudyContentsSummary from "../../components/study-page/StudyContentsSummary.astro";
import DatasetInfo from "../../components/DatasetInfo.astro";
import ViewableImageTable from "../../components/ViewableImageTable.astro";
import DatasetFilesTable from "../../components/DatasetFilesTable.astro";
import StudyFiles from "../../components/StudyFiles.astro";
import Citation from "../../components/Citation.astro";

import { getMetadataValue, multilineTextRender, formatBytesToHumanSize, getStudyImage, getDatasetStatsByUUID, getStudyFromApiByAccession, getAllStudiesFromAPI} from "../../components/SharedJSFunctions.js"
import { type Study } from "../../components/SharedInterface.astro"

export async function getStaticPaths() {
  const studyMetadata = await getAllStudiesFromAPI();
  return studyMetadata.map((study) => {
    return {
      params: { accessionID: study.accession_id },
    };
  });
}

const tableOfContents = {
  "Study Information": "study",
  "Linked Information": "linked_information", 
  "Datasets": "study_components",
  "Viewable Images": "viewable_images",
};

const { accessionID } = Astro.params;
const study = await getStudyFromApiByAccession(accessionID) as Study;
const images = study?.dataset.flatMap(dataset => dataset.image ?? [])

if (!Array.isArray(study.see_also) || study.see_also.length === 0) {
  delete tableOfContents["Linked Information"];
}

// Pre-process grants to group them by funder name
const groupedGrants = {};
if (study?.grant && Array.isArray(study.grant)) {
  for (const grant of study.grant) {
    // We use the first funder's display name as the grouping key for simplicity
    const funderName = 
      (grant.funder && Array.isArray(grant.funder) && grant.funder.length > 0)
        ? grant.funder[0].display_name
        : 'Other Grant'; // Fallback name if no funder is specified

    // Ensure we have a grant ID
    if (grant.id) {
        if (!groupedGrants[funderName]) {
            groupedGrants[funderName] = [];
        }
        
        // Store the grant ID and the funder name (for the Europe PMC query's 'ga' parameter)
        groupedGrants[funderName].push({
            id: grant.id,
            funderName: funderName
        });
    }
  }
}
// End grant pre-processing
function getFileTypes(study) {
    const fileTypeList = []
    for (var dataset of study.dataset) {
        for (const file_type of dataset.file_type_aggregation) {
            if (!fileTypeList.includes(file_type)) {
              fileTypeList.push(file_type)
            }
        }
    }
    return fileTypeList
}

const datasetUUIDsAndFileStats = getDatasetStatsByUUID(study);
const exampleStudyImage = getStudyImage(study);

function getImageUUIDFromStudyImage(exampleURI, images){
  const thumbnailImage = images.find(img => {
    const meta = getMetadataValue(img.additional_metadata, "image_static_display_uri");
    return meta?.slice?.uri === exampleURI;
  });
  return thumbnailImage?.uuid || ""
}

const studyImagePageLink = getImageUUIDFromStudyImage(exampleStudyImage, images);

const headlineStats = {
  "Total Viewable Images":  study?.dataset.reduce((accumulator, dataset) => accumulator + dataset.image_count, 0) || 0,
  "Total files": study?.dataset.reduce((accumulator, dataset) => accumulator + dataset.file_reference_count, 0) || 0,
  "Total size of files": formatBytesToHumanSize(study?.dataset.reduce((accumulator, dataset) => accumulator + dataset.file_reference_size_bytes, 0) || 0),
};

const linkTypeFormatting = {
  "biostudies": "BioStudies",
  "https": "HTTPS",
  "arrayexpress": "ArrayExpress",
  "empiar": "EMPIAR"
}
function formatLinkType(link_type) {
  if (!link_type) return "";
  return linkTypeFormatting[link_type.toLowerCase()] ?? link_type;
}
export const formatAuthor = (name = "") => {
  let n = name.trim().replace(/\s+/g, " ").replace(/\b\, PhD\b.*$/i, "").replace(", ", " ");
  if (!n) return "";
  if (/\b(lab|labs|laboratory|institute|center|centre|department|university|group|consortium)\b/i.test(n)) return n;
  return n
};


export const doiToTag = (doi?: string | null) =>
  doi?.trim() ? `<a class="vf-link" href=${doi}>doi:${doi.trim().replace(/^https?:\/\/doi\.org\//i, "")}</a>` : "";

export const generateHowToCiteText = (study: Study) => {
  const authors = (study.author ?? [])
    .map(a => formatAuthor(a.display_name))
    .filter(Boolean)
    .join(", ");

  const repo = study.accession_id?.includes("EMPIAR") ? "EMPIAR" : "BioImage Archive";
  const urlForStudy = repo ==="EMPIAR"? "https://www.ebi.ac.uk/empiar/": "https://www.ebi.ac.uk/biostudies/BioImages/studies/"
  const doi = doiToTag(study.doi) || `<a class="vf-link" href="${urlForStudy}${study.accession_id}">${urlForStudy}${study.accession_id}</a>`;

  return [authors, `(${study.release_date.split("-")[0]})`, study.title.trim()+".", ` ${repo}, ${study.accession_id}.`, doi]
    .filter(Boolean)
    .join(" ") + ".";
};
const howToCite = generateHowToCiteText(study);
const breadcrumbs = [
  "/bioimage-archive",
  "/bioimage-archive/studies",
]
---

<BaseLayoutWithBreadcrumbs pageTitle={`${study.accession_id}: ${study.title}`} breadcrumbs={breadcrumbs}>
  <body>
    <StudyTitleInfo study_info={study}/>

  <StudyContentsSummary 
    tableOfContents={tableOfContents} 
    originalStudyLink={`https://www.ebi.ac.uk/biostudies/BioImages/studies/${study.accession_id}`} 
    headlineStats={headlineStats}
  >
    <div slot="hero-image">
      <figure class="vf-figure vf-figure--align vf-figure--align-centered">
        <a href={studyImagePageLink? `/bioimage-archive/image/${studyImagePageLink}`: ""}><img class="vf-figure__image" src={exampleStudyImage} /></a>
      </figure>
    </div>
    <div slot="ftp-link">
      <StudyFiles accessionID={accessionID}/>
    </div>
    <div slot="how-to-cite" style="word-wrap: break-word;"><Citation howToCite={howToCite}/></div>
  </StudyContentsSummary>

  <hr/>
  <ViewableImageTable study={study} images={images}/>
  <hr />
<section id="study" class="vf-content | embl-grid embl-grid--has-centered-content">
  <div>
    <h2 class="vf-section-header__heading">Study Information</h2>
  </div>

  <div style="overflow-wrap: anywhere;">
    <div class="study-info-item">
      <b>Description: </b> <Fragment set:html={multilineTextRender(study.description)}></Fragment>
    </div>
    {study.keyword && Array.isArray(study.keyword) && study.keyword.length > 0 && (    
      <div class="study-info-item">
        <b>Keywords: </b> {study.keyword.join(", ")}
      </div>      
    )}
    <div class="study-info-item">
      <b>Licence: </b> <a href={study.licence}>{study.licence}</a>
    </div>
    {Array.isArray(study.related_publication) && study.related_publication.length > 0 && (
      <div class="study-info-item">
        <b>Publication:</b>
        <ul>
          {study.related_publication.map((pub, i) => {
            const { authors_name, publication_year, title, pubmed_id, doi } = pub;
            const titleLink = pubmed_id ? `https://pubmed.ncbi.nlm.nih.gov/${pubmed_id}` : null;
            const doiLink = doi ? doi : null;
            return (
              <li style={{ fontSize: "inherit", lineHeight: "inherit" }}>
                {authors_name || "Unknown authors"}.
                {titleLink ? (
                  <a href={titleLink} target="_blank">{title || "Untitled"}</a>
                ) : (
                  title || "Untitled"
                )}
                {publication_year && ` (${publication_year})`}
                {doi && (
                  <>
                    . doi:{" "}
                    {doiLink ? (
                      <a href={doiLink} target="_blank">{doi.replace("https://doi.org/", "")}</a>
                    ) : (
                      doi
                    )}
                  </>
                )}
              </li>
            );
          })}
        </ul>
      </div>
    )}

    {study.acknowledgement && (
      <div class="study-info-item">
        <b>Acknowledgements: </b> <Fragment set:html={multilineTextRender(study.acknowledgement)}></Fragment>
      </div>
    )}
    {study.funding_statement &&  (
      <div class="study-info-item">
        <b>Funding statement: </b> <Fragment set:html={multilineTextRender(study.funding_statement)}></Fragment>
      </div>
    )}
    {Object.keys(groupedGrants).length > 0 && (
      <div class="study-info-item">
        <b>Grant information:</b>
        <ul>
          {/* Iterate over the grouped grants (funderName -> list of grant objects) */}
          {Object.entries(groupedGrants).map(([funderName, grants]) => (
            <li style="font-size: inherit; line-height: inherit;">
                {funderName}:
                {/* Map over the grant IDs associated with this funder */}
                {Object.values(grants).map((grant, index) => {
                    // Construct the specific Europe PMC query using gid:"ID" ga:"FUNDER NAME"
                    const epaQuery = `gid:"${grant.id}" ga:"${grant.funderName}"`;
                    const encodedQuery = encodeURIComponent(epaQuery);
                    const finalHref = `https://europepmc.org/grantfinder/grantdetails?query=${encodedQuery}`;

                    return (
                        <Fragment>
                            <a 
                                href={finalHref} 
                                target="_blank"
                                title={`Search Europe PMC for Grant ID: ${grant.id} funded by ${grant.funderName}`}
                            >
                                {grant.id}
                            </a>
                            {/* Add a space separator if it's not the last grant ID in the list */}
                            {Array.isArray(grants) &&  index < grants?.length - 1 && ' '}
                        </Fragment>
                    )
                })}
            </li>
          ))}
        </ul>
      </div>
    )}
  </div>
</section>

  <hr/>
  {Array.isArray(study.see_also) && study.see_also.length > 0 && (
    <section id="linked_information" class="vf-content | embl-grid embl-grid--has-centered-content">
      <div>
        <h2 class="vf-section-header__heading">Linked Information</h2>
      </div>
      <div>
        <ul>
          {
            study.see_also.map((linkedInfo, i) => {
              const { link, link_type, description } = linkedInfo;
              return (
                <li style={{ fontSize: "inherit", lineHeight: "inherit" }}>
                  {link_type? <b>{formatLinkType(link_type)}.</b> : ""}
                  {description? `${description}: ` : ""}
                  {link? <a href={link} target="_blank">{link}</a>: ""}
                </li>
              )
            })
          }
        </ul>
      </div>

    </section>
    <hr/>
  )}


  {Array.isArray(study.dataset) && study.dataset.length > 0 && (
    <section id="study_components" class="vf-content | embl-grid embl-grid--has-centered-content">
      <div>
        <h2 class="vf-section-header__heading">Datasets</h2>
      </div>
      <div>
        {
          study.dataset.map((dataset) => (
            <DatasetInfo dataset={dataset} />
          ))
        }
      </div>
    </section>
  )}

</BaseLayout>

<style>
  .study-info-item {
    margin-bottom: 1rem;
  }
</style>