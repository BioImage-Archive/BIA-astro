---
import BaseLayout from '../../layouts/BaseLayoutWithBreadcrumbs.astro';
import sdataImages from '../../data/collections/spatialdata_summaries_simple.json';
---

<script is:inline>
function parseS3Uri(url) {
  try {
    if (!url || typeof url !== 'string') return null;
    const urlObj = new URL(url);
    const endpoint = `${urlObj.protocol}//${urlObj.host}`;
    const segments = urlObj.pathname.split('/').filter(s => s.length > 0);
    if (segments.length < 2) return null;
    const bucket = segments[0];
    const key = segments.slice(1).join('/');
    return { bucket, key, endpoint };
  } catch (e) {
    console.error('Failed to parse URL:', e);
    return null;
  }
}

function copySpatialURI(button) {
  const uri = button.getAttribute('data-uri');
  const s3Info = parseS3Uri(uri);

  const dialog = document.createElement('dialog');
  dialog.innerHTML = `
    <div style="padding: 20px; text-align: left; max-width: 600px;">
      <h3 style="margin-bottom: 15px; text-align: center;">Spatialdata S3 Location</h3>
      <div style="margin-bottom: 15px;">
        <h4 style="margin: 10px 0;">S3 URI:</h4>
        <p style="word-break: break-all; font-family: monospace; background: #f5f5f5; padding: 10px; border-radius: 4px;">${uri}</p>
      </div>
      <h4 style="margin: 15px 0;">Download with AWS CLI:</h4>
      <p style="margin-bottom: 10px;">1. Install the AWS CLI if you haven't already.</p>
      <p style="margin-bottom: 10px;">2. Download the data recursively (no credentials needed):</p>
      <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 15px; overflow-x: auto;">aws s3 cp --no-sign-request --endpoint-url ${s3Info ? s3Info.endpoint : ''} "s3://${s3Info ? s3Info.bucket : ''}/${s3Info ? s3Info.key : ''}" "${s3Info ? s3Info.key.split('/').pop() : ''}" --recursive</pre>
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
        <button onclick="navigator.clipboard.writeText('${uri}').then(() => this.closest('dialog').close())">Copy S3 URI</button>
        <button onclick="navigator.clipboard.writeText('aws s3 cp --no-sign-request --endpoint-url ${s3Info ? s3Info.endpoint : ''} \'s3://${s3Info ? s3Info.bucket : ''}/${s3Info ? s3Info.key : ''}\' \'${s3Info ? s3Info.key.split('/').pop() : ''}\' --recursive').then(() => this.closest('dialog').close())">Copy AWS Command</button>
        <button onclick="this.closest('dialog').close()">Close</button>
      </div>
    </div>
  `;
  dialog.style.border = '1px solid #ccc';
  dialog.style.borderRadius = '8px';
  dialog.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
  dialog.style.maxWidth = '80vw';
  document.body.appendChild(dialog);
  try { dialog.showModal(); } catch(e) { console.warn('dialog.showModal not supported', e); }
  dialog.addEventListener('close', () => dialog.remove());
}
</script>

<BaseLayout pageTitle="Spatialdata Gallery — Simple">
  <body>
    <section style="max-width: var(--vf-content-max-width,1200px); margin: 0 auto; padding: 2rem 1rem;">
      <h1>Spatialdata — Simple View</h1>
      <p>This simplified gallery lists spatialdata objects with only two actions: <strong>View</strong> (browser viewer) and <strong>Copy uri</strong> (Spatialdata URI).</p>
    </section>

    <section class="simple-grid" style="max-width: var(--vf-content-max-width,1200px); margin: 0 auto; padding: 1rem;">
      { Object.entries(sdataImages).map(([uuid, image]) => (
        <article class="simple-card" key={uuid}>
          { image.thumbnail_src ? (
            <div class="card-thumb-wrap">
              <img class="card-thumb" src={image.thumbnail_src} alt={`Thumbnail for ${image.label}`} loading="lazy" />
            </div>
          ) : null }
          <div class="card-content">
            <div class="card-title">{image.label}</div>
            <div class="card-sub">{image.submitted_in_study_accession}</div>
          </div>
          <div class="card-actions">
            {image.view_link ? <a class="btn view" href={image.view_link} target="_blank" rel="noopener">View</a> : null}
            {image.submitted_in_study_accession ? <a class="btn raw" href={"/bioimage-archive/study/" + image.submitted_in_study_accession} title="View Metadata"> Experiment Metadata</a> : null}
            {image.raw_data_link ? <button class="btn raw" title="Copy Spatialdata URI" onclick="copySpatialURI(this)" data-uri={image.raw_data_link}>Copy Spatialdata uri</button> : null}
          </div>
        </article>
      ))}
    </section>

    <style>
      .simple-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1rem;
      }
      .simple-card {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border: 1px solid #e6e6e6;
        border-radius: 6px;
        padding: 12px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        min-height: 100px;
      }
      .card-thumb-wrap {
        width: 100%;
        overflow: hidden;
        border-radius: 6px;
        margin-bottom: 10px;
      }
      .card-thumb {
        display: block;
        width: 100%;
        height: 140px;
        object-fit: cover;
      }
      .card-title {
        font-weight: 600;
        margin-bottom: 6px;
      }
      .card-sub {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 8px;
      }
      .card-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .btn {
        display: inline-block;
        padding: 6px 8px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.75rem;
        border: 1px solid transparent;
        flex: 0 1 auto;
        white-space: nowrap;
      }
      .btn.view {
        background: #3b6fb6;
        color: #fff;
      }
      .btn.raw {
        background: #f5f5f5;
        color: #333;
        border-color: #ddd;
      }
      .btn:hover { opacity: 0.95; }
    </style>
  </body>
</BaseLayout>
